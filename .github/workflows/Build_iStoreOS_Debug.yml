name: Build iStore OS Debug

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      repo_branch:
        description: 'iStoreOS ä»“åº“åˆ†æ”¯'
        required: true
        default: 'istoreos-22.03'
      lan_ip:
        description: 'è®¾ç½®LAN IPåœ°å€'
        required: true
        default: '192.168.10.1'
      os_name:
        description: 'è®¾ç½®ç³»ç»Ÿåç§°'
        required: true
        default: 'iStore OS'
      enable_wifi:
        description: 'å¯ç”¨WiFi'
        required: true
        default: true
        type: boolean
      ssh:
        description: 'SSH connection to Actions'
        required: false
        default: 'false'
  # schedule:
  #  - cron: 0 16 * * *

env:
  REPO_URL: https://github.com/istoreos/istoreos
  FEEDS_CONF: feeds.conf
  CONFIG_FILE: .config
  DIY_P1_SH: scripts/istoreos/diy-part1.sh
  DIY_P2_SH: scripts/istoreos/diy-part2.sh
  WORK_DIR: /mnt/workdir
  UPLOAD_BIN_DIR: true
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai
  GITHUB_TOKEN: ${{ secrets.ACCESS_TOKEN }}

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false  # å…è®¸å…¶ä»–æ¶æ„ç»§ç»­æ„å»º
      matrix:
        os: ['ubuntu-22.04'] # å¯ä»¥æ·»åŠ æ›´å¤šæ“ä½œç³»ç»Ÿ
        target: [x86, n1, rk35xx, rk33xx] # ä½¿ç”¨çŸ©é˜µæ¥å¹¶è¡ŒåŒ–æ„å»ºä¸åŒçš„ç›®æ ‡ 
        include:
          - target: n1
            use_ngrok: true
            use_sleep: false
          - target: x86 
            use_ngrok: false
            use_sleep: false
          - target: rk33xx
            use_ngrok: false 
            use_sleep: false
          - target: rk35xx
            use_ngrok: false
            use_sleep: false 

    steps:
    - name: å‡†å¤‡å®Œæˆ
      uses: actions/checkout@v4
    - name: éªŒè¯è¾“å…¥å‚æ•°
      run: |
        echo "å¼€å§‹éªŒè¯è¾“å…¥å‚æ•°..."
        echo "éªŒè¯ä»“åº“åˆ†æ”¯æ˜¯å¦å­˜åœ¨..."
        if ! git ls-remote --exit-code --heads $REPO_URL refs/heads/${{ github.event.inputs.repo_branch }}; then
          echo "::error::âŒ é”™è¯¯ï¼šåˆ†æ”¯ '${{ github.event.inputs.repo_branch }}' ä¸å­˜åœ¨äºä»“åº“ä¸­ï¼"
          exit 1
        fi
        echo "éªŒè¯LAN IPåœ°å€æ ¼å¼ï¼š${{ github.event.inputs.lan_ip }}"
        LAN_IP="${{ github.event.inputs.lan_ip }}"
        if ! echo "$LAN_IP" | grep -Eq '^([0-9]{1,3}\.){3}[0-9]{1,3}$'; then
          echo "::error::âŒ é”™è¯¯ï¼šIPåœ°å€æ ¼å¼æ— æ•ˆ '$LAN_IP'ï¼Œå¿…é¡»ä¸º IPv4 æ ¼å¼ï¼ˆå¦‚ 192.168.1.1ï¼‰"
          exit 1
        fi
        IFS='.' read -ra OCTETS <<< "$LAN_IP"
        for OCTET in "${OCTETS[@]}"; do
          if [[ $OCTET -lt 0 || $OCTET -gt 255 ]]; then
            echo "::error::âŒ é”™è¯¯ï¼šIPåœ°å€ '$LAN_IP' åŒ…å«æ— æ•ˆæ•°å­—ï¼ˆå¿…é¡» 0-255ï¼‰"
            exit 1
          fi
        done
        if [[ ! $LAN_IP =~ ^(192\.168|10\.|172\.(1[6-9]|2[0-9]|3[0-1])) ]]; then
          echo "::warning::âš ï¸ æ³¨æ„ï¼šLAN IP '$LAN_IP' ä¸æ˜¯æ ‡å‡†å†…ç½‘åœ°å€ï¼ˆå»ºè®®ä½¿ç”¨ 192.168.x.x/10.x.x.x/172.16-31.x.xï¼‰"
        fi
        
    - name: Setup SSH tunnel
      if: ${{ matrix.use_ngrok == true }}
      uses: qiaodapei/github-ngrok-ssh@main
      with:
        timeout: 6h
        ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}
        ngrok_token: ${{ secrets.NGROK_TOKEN }}

    - name: æ£€æŸ¥æœåŠ¡å™¨é…ç½®
      run: |
        echo "è‹¥åˆ†é…çš„æœåŠ¡å™¨æ€§èƒ½ä¸è¶³ï¼ŒåŠ¡å¿…åŠæ—¶å–æ¶ˆï¼Œé‡æ–°è¿è¡Œï¼"
        echo -e "------------------------------- CPUä¿¡æ¯ -------------------------------\n"
        echo "CPUç‰©ç†æ•°é‡:$(cat /proc/cpuinfo| grep 'physical id'| sort| uniq| wc -l)"
        echo -e "CPUæ ¸å¿ƒåŠç‰ˆæœ¬ä¿¡æ¯: $(cat /proc/cpuinfo | grep name | cut -f2 -d: | uniq -c) \n"
        echo -e "------------------------------- å†…å­˜ä¿¡æ¯ -------------------------------\n"
        echo "å·²å®‰è£…å†…å­˜è¯¦ç»†ä¿¡æ¯: "
        sudo lshw -short -C memory | grep GiB
        echo -e "\n"
        echo -e "------------------------------- ç£ç›˜ä¿¡æ¯ -------------------------------\n"
        echo -e "ç£ç›˜æ•°é‡: $(ls /dev/sd* | grep -v '[1-9]' | wc -l) \n"
        echo "------------------------------- ç£ç›˜è¯¦æƒ… -------------------------------\n"
        df -Th

    - name: å®‰è£… Go 1.21.1
      uses: actions/setup-go@v5
      with:
        go-version: 1.21.1

    - name: åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        echo "------------------------------- æ›´æ–°å¹¶å®‰è£…ä¾èµ– -------------------------------"
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /etc/mysql /etc/php /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq update
        DEPENDS_FILE="$GITHUB_WORKSPACE/depends/${{ matrix.os }}"
        if [ -f "$DEPENDS_FILE" ]; then
          echo "æ­£åœ¨ä» $DEPENDS_FILE è¯»å–ä¾èµ–..."
          sudo -E apt-get -qq install $(cat "$DEPENDS_FILE")
        fi
        wget https://bootstrap.pypa.io/pip/3.6/get-pip.py
        sudo python3 get-pip.py
        sudo rm -rf get-pip.py
        sudo pip install pyelftools
        echo "------------------------------- æ¸…ç†Dockeré•œåƒå’Œè½¯ä»¶ -------------------------------"
        docker rmi $(docker images -q)
        docker image prune -a -f
        sudo -E apt-get -y purge azure-cli ghc* zulu* hhvm llvm* firefox google* dotnet* powershell openjdk* adoptopenjdk* mysql* php* mongodb* dotnet* moby* snapd* android* || true
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        echo "------------------------------- è®¾ç½®å·¥ä½œç›®å½•åŠæ—¶åŒº -------------------------------"
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /mnt/workdir
        sudo chown $USER:$GROUPS /mnt/workdir

    - name: å…‹éš†æºç 
      working-directory: /mnt/workdir
      run: |
        df -hT $PWD
        REPO_BRANCH=${{ github.event.inputs.repo_branch }}
        git clone $REPO_URL -b $REPO_BRANCH openwrt || {
          echo "::error::âŒ ä»“åº“å…‹éš†å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ä»“åº“æƒé™";
          exit 1;
        }
        if [ ! -d "openwrt/.git" ]; then
          echo "::error::âŒ é”™è¯¯ï¼šä»“åº“å…‹éš†ä¸å®Œæ•´ï¼Œç¼ºå°‘.gitç›®å½•"
          exit 1
        fi
        cd openwrt
        git checkout $REPO_BRANCH || {
          echo "::error::âŒ æ— æ³•åˆ‡æ¢åˆ°æŒ‡å®šåˆ†æ”¯ '$REPO_BRANCH'";
          exit 1;
        }
        ln -sf /mnt/workdir/openwrt $GITHUB_WORKSPACE/openwrt

    - name: ç¼“å­˜æ„å»ºåŠ¨ä½œ
      uses: klever1988/cachewrtbuild@main
      with:
        ccache: 'true'
        mixkey: ${{ matrix.target }}-${{ github.event.inputs.repo_branch }}
        prefix: ${{ github.workspace }}/openwrt

    - name: åŠ è½½è‡ªå®šä¹‰ feeds
      env:
        FEEDS_CONF_PATH: iStoreOS/${{ matrix.target }}/${{ env.FEEDS_CONF }}
      run: |
        [ -e $FEEDS_CONF_PATH ] && mv $FEEDS_CONF_PATH openwrt/$FEEDS_CONF
        chmod +x $DIY_P1_SH
        cd openwrt
        $GITHUB_WORKSPACE/$DIY_P1_SH

    - name: æ›´æ–° feeds
      run: cd openwrt && ./scripts/feeds update -a

    - name: å®‰è£… feeds
      run: cd openwrt && ./scripts/feeds install -a

    - name: åŠ è½½è‡ªå®šä¹‰é…ç½®
      env:
        CONFIG_FILE_PATH: iStoreOS/${{ matrix.target }}/${{ env.CONFIG_FILE }}
      run: |
        [ -e files ] && mv files openwrt/files
        [ -e $CONFIG_FILE_PATH ] && mv $CONFIG_FILE_PATH openwrt/$CONFIG_FILE
        cat openwrt/$CONFIG_FILE
        chmod +x $DIY_P2_SH
        cd openwrt
        $GITHUB_WORKSPACE/$DIY_P2_SH ${{ matrix.target }}

    - name: è®¾ç½®LAN IPåœ°å€ï¼ˆè·¯ç”±å™¨ç™»å½•åœ°å€ï¼‰
      run: |
        cd openwrt || exit 1
        CONFIG_FILE="package/base-files/files/bin/config_generate"
        if [ ! -f "$CONFIG_FILE" ]; then
          echo "::error::âŒ é…ç½®æ–‡ä»¶ $CONFIG_FILE ä¸å­˜åœ¨"
          exit 1
        fi
        SET_IP="${{ github.event.inputs.lan_ip }}"
        if ! sed -i "s/192\.168\.[0-9]*\.[0-9]*/$SET_IP/g" "$CONFIG_FILE"; then
          echo "::error::âŒ IPåœ°å€æ›¿æ¢å¤±è´¥"
          exit 1
        fi
        # ä¿®æ­£grepæ£€æŸ¥æ¨¡å¼ï¼šåŒ¹é…å®é™…å˜é‡å ipad
        if ! grep -q "ipad=.*$SET_IP" "$CONFIG_FILE"; then
          echo "::error::âŒ IPåœ°å€è®¾ç½®æœªç”Ÿæ•ˆï¼Œæ£€æŸ¥æ›¿æ¢åå†…å®¹ï¼š"
          grep "ipad=" "$CONFIG_FILE"
          exit 1
        fi

    - name: è®¾ç½®ç³»ç»Ÿåç§°
      run: |
        cd openwrt
        set_os_name="${{ github.event.inputs.os_name }}"
        # æ·»åŠ é˜²ç©ºæ ¡éªŒ
        if [ -z "$set_os_name" ]; then
          echo "::error::âŒ ç³»ç»Ÿåç§°ä¸èƒ½ä¸ºç©º"
          exit 1
        fi
        sed -i "s/OpenWrt/${set_os_name}/g" package/base-files/files/bin/config_generate || {
          echo "::error::âŒ ç³»ç»Ÿåç§°æ›¿æ¢å¤±è´¥"
          exit 1
        }
    
    # - name: ä¿®æ”¹å›ºä»¶åç§°
    #   run: |
    #     cd openwrt
    #     # æå–ä¸»ç‰ˆæœ¬å·
    #     VERSION_NUMBER=$(awk -F '[ ,]' '/VERSION_NUMBER:=/ {for(i=1; i<=NF; i++) {if ($i ~ /[0-9]+\.[0-9]+\.[0-9]+/) {gsub(/[^0-9.]/, "", $i); print $i; exit}}}' include/version.mk)
    #     # ç”Ÿæˆæ—¥æœŸç‰ˆæœ¬
    #     date_version=$(date +"%Y%m%d%H")
    #     # 1. ä¿®æ”¹ IMG_PREFIX ä¸º istoreos
    #     # sed -i "s|IMG_PREFIX?=.*|IMG_PREFIX?=istoreos-\$(REVISION)|" include/image.mk
    #     # 2. è°ƒæ•´ DEVICE_IMG_PREFIX é™„åŠ ç‰ˆæœ¬å’Œæ—¥æœŸ
    #     sed -i "s|DEVICE_IMG_PREFIX := \$(IMG_PREFIX)-\$(1)|DEVICE_IMG_PREFIX := \$(IMG_PREFIX)-${VERSION_NUMBER}-${date_version}-\$(1)|" include/image.mk
    #     # ä¿®æ”¹ç‰ˆæœ¬å·ä¸ºæ—¥æœŸ
    #     cat << EOF > config_snippet
    #     CONFIG_VERSIONOPT=y
    #     CONFIG_VERSION_CODE=${date_version}
    #     EOF
    #     ./scripts/kconfig.pl /dev/null config_snippet >> .config
    #     # åç»­æ“ä½œï¼ˆä¿®æ”¹æè¿°ç­‰ï¼‰
    #     author="Loki"
    #     sed -i "s/DISTRIB_DESCRIPTION.*/DISTRIB_DESCRIPTION='%D %V %C by ${author}'/g" package/base-files/files/etc/openwrt_release
    #     # sed -i "s/BUILD_ID.*/BUILD_ID=\"${date_version}\"/g" package/base-files/files/usr/lib/os-release
    - name: ä¿®æ”¹å›ºä»¶åç§°
      run: |
        cd openwrt
        # ç”Ÿæˆæ—¥æœŸç‰ˆæœ¬ï¼ˆä¸Šæµ·æ—¶åŒºï¼‰
        date_version=$(TZ=Asia/Shanghai date +"%Y%m%d%H")
        # æ­¥éª¤ 1ï¼šç”ŸæˆåŸºç¡€é…ç½®
        make defconfig
        # æ­¥éª¤ 2ï¼šåˆ›å»ºç¬¦åˆ Kconfig è§„èŒƒçš„é…ç½®ç‰‡æ®µ
        cat << EOF > config_snippet
        CONFIG_VERSIONOPT=y
        CONFIG_VERSION_DIST=""
        CONFIG_VERSION_NUMBER=""
        CONFIG_VERSION_CODE="$date_version"
        EOF
        # æ­¥éª¤ 3ï¼šè°ƒè¯•è¾“å‡ºç‰‡æ®µå†…å®¹
        echo "=== config_snippet å†…å®¹ ==="
        cat config_snippet
        # æ­¥éª¤ 4ï¼šæ­£ç¡®åˆå¹¶é…ç½®ï¼ˆå…³é”®ä¿®å¤ç‚¹ï¼‰
        # ./scripts/kconfig.pl .config config_snippet > .config.merged
        # mv .config.merged .config
        # rm config_snippet
        # æ­¥éª¤ 5ï¼šéªŒè¯é…ç½®åˆå¹¶
        echo "æ£€æŸ¥åˆå¹¶åçš„é…ç½®ï¼š"
        grep "CONFIG_VERSION_CODE" .config
        # æå–ä¸»ç‰ˆæœ¬å·
        VERSION_NUMBER=$(awk -F '[ ,]' '/VERSION_NUMBER:=/ {for(i=1; i<=NF; i++) {if ($i ~ /[0-9]+\.[0-9]+\.[0-9]+/) {gsub(/[^0-9.]/, "", $i); print $i; exit}}}' include/version.mk)
        # è°ƒæ•´ DEVICE_IMG_PREFIX é™„åŠ ç‰ˆæœ¬å’Œæ—¥æœŸ
        sed -i "s|DEVICE_IMG_PREFIX := \$(IMG_PREFIX)-\$(1)|DEVICE_IMG_PREFIX := \$(IMG_PREFIX)-${VERSION_NUMBER}-${date_version}-\$(1)|" include/image.mk
        # ä¿®æ”¹æè¿°æ–°å¢ä½œè€…
        author="Loki"
        sed -i "s/DISTRIB_DESCRIPTION.*/DISTRIB_DESCRIPTION='%D %V %C by ${author}'/g" package/base-files/files/etc/openwrt_release

    - name: å¯ç”¨WiFi
      if: github.event.inputs.enable_wifi == 'true'
      run: |
        cd openwrt
        WIFI_FILE="package/kernel/mac80211/files/lib/wifi/mac80211.sh"
        if [ ! -f "$WIFI_FILE" ]; then
          echo "::error::âŒ é”™è¯¯ï¼šæ— çº¿é…ç½®æ–‡ä»¶ $WIFI_FILE ä¸å­˜åœ¨"
          exit 1
        fi
        
        sed -i 's/disabled=1/disabled=0/g' $WIFI_FILE || {
          echo "::error::âŒ æ— çº¿é…ç½®ä¿®æ”¹å¤±è´¥";
          exit 1;
        }

    - name: ä¸‹è½½è½¯ä»¶åŒ…
      id: package
      run: |
        cd openwrt
        if [ ! -f "$CONFIG_FILE" ]; then
          echo "::error::âŒ é”™è¯¯ï¼šé…ç½®æ–‡ä»¶ $CONFIG_FILE ä¸å­˜åœ¨"
          exit 1
        fi
        make defconfig
        make download -j8 || {
          echo "::error::âŒ è½¯ä»¶åŒ…ä¸‹è½½å¤±è´¥";
          exit 1;
        }
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    - name: ç¼–è¯‘å›ºä»¶
      id: compile
      run: |
        cd openwrt
        echo "ä½¿ç”¨ $(nproc) çº¿ç¨‹è¿›è¡Œç¼–è¯‘..."
        echo "FILE_DATE=$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV
        set +eo pipefail
        make -j$(nproc) || {
          echo "::warning::âš ï¸ å¹¶è¡Œç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹ç¼–è¯‘...";
          make -j1 || {
            echo "::error::âŒ ä¸¥é‡é”™è¯¯ï¼šç¼–è¯‘æœ€ç»ˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ä»¥ä¸‹å¯èƒ½åŸå› ï¼š
            1. è½¯ä»¶åŒ…ä¾èµ–ä¸æ»¡è¶³
            2. é…ç½®æ–‡ä»¶å­˜åœ¨å†²çª
            3. ç³»ç»Ÿèµ„æºä¸è¶³";
            exit 1;
          }
        }
        echo "::set-output name=status::success"

    - name: æ£€æŸ¥ç£ç›˜ç©ºé—´
      if: (!cancelled())
      run: df -hT

    - name: ä¸Šä¼  bin æ–‡ä»¶å¤¹
      uses: actions/upload-artifact@main
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true'
      with:
        name: OpenWrt_bin_${{ matrix.target }}_${{ env.FILE_DATE }}
        path: openwrt/bin

    - name: æ•´ç†å›ºä»¶æ–‡ä»¶
      id: organize
      if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
      run: |
        cd openwrt/bin/targets/*/*
        rm -rf packages
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "::set-output name=status::success"

    - name: ä¸Šä¼ å›ºä»¶ç›®å½•
      uses: actions/upload-artifact@main
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: OpenWrt_firmware_${{ matrix.target }}_${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE }}

    - name: ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
      id: tag
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true' && !cancelled()
      run: |
        echo "::set-output name=release_tag::${{ matrix.target }}"
        touch release.txt
        echo "
        ğŸ’» æ¶æ„: ${{ matrix.target }}

        ğŸ“‚ æºç : ${{ env.REPO_URL }}

        ğŸŒ³ åˆ†æ”¯: ${{ github.event.inputs.repo_branch }}

        â±ï¸ ç¼–è¯‘æ—¶é—´: $(date +"%Yå¹´%mæœˆ%dæ—¥%Hæ—¶%Måˆ†")

        ğŸŒ ç®¡ç†åœ°å€: 192.168.10.1

        ğŸ‘¤ ç”¨æˆ·å: root

        ğŸ”’ å¯†ç : password " >> release.txt
        echo "::set-output name=status::success"

    - name: è‡ªåŠ¨å‘å¸ƒå›ºä»¶åˆ° Releases
      uses: softprops/action-gh-release@v1
      if: steps.tag.outputs.status == 'success' && !cancelled()
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
        files: ${{ env.FIRMWARE }}/*

    - name: åˆ é™¤è¿è¡Œè®°å½•
      uses: GitRML/delete-workflow-runs@main
      with:
        retain_days: 1
        keep_minimum_runs: 3
        token: ${{ env.GITHUB_TOKEN }}

    - name: åˆ é™¤è‡ªåŠ¨å‘å¸ƒçš„æ—§å›ºä»¶
      uses: dev-drprasad/delete-older-releases@v0.1.0
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      with:
        keep_latest: 6
        delete_tags: true
    - name: Keep ngrok running
      if: ${{ matrix.use_sleep == true }}
      run: |
        sleep 43200  # Sleep for 12 hours (7200 seconds)
        pkill ngrok  # Kill the ngrok process after 12 hours
